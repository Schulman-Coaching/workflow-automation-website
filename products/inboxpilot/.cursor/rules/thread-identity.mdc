---
description: Standards for managing internal vs provider-specific identities for emails and threads.
globs: ["**/prisma/schema.prisma", "**/src/email/**/*.ts"]
---

# Thread and Email Identity Standards

To prevent cross-tenant and cross-account data collisions, always separate internal identities from provider-specific identities.

## Rules

- **Internal IDs**: All database primary keys (e.g., `Email.id`, `EmailThread.id`) MUST be UUIDs generated by the application or database.
- **Provider IDs**: IDs from external providers (Gmail, Outlook) MUST be stored in separate fields (e.g., `providerId`, `providerThreadId`).
- **Uniqueness**: Enforce uniqueness for provider IDs within the scope of an account. The database schema should use composite unique constraints on `(organizationId, emailAccountId, providerId)`.
- **Querying**: When looking up a record based on a provider's notification or webhook, always include `organizationId` and `emailAccountId` in the lookup.

## Examples

### Correct Schema Definition
```prisma
model Email {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  emailAccountId  String   @map("email_account_id")
  providerId      String   @map("provider_id")
  // ...
  @@unique([organizationId, emailAccountId, providerId])
}
```

### Incorrect Schema Definition
```prisma
model Email {
  id              String   @id // Using provider ID as primary key
  // ...
}
```
